name: Auto Fix Vulnerabilities

on:
  schedule:
    - cron: '0 6 * * 3'
  workflow_dispatch:

jobs:
  auto-fix:
    name: Auto Fix Vulnerabilities
    runs-on: ubuntu-latest

    strategy:
      matrix:
        project: [server, client]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.project }}
        run: npm ci

      - name: Check for vulnerabilities
        working-directory: ${{ matrix.project }}
        id: audit
        run: |
          echo "🔍 Checking for vulnerabilities in ${{ matrix.project }}..."
          if npm audit --audit-level=moderate; then
            echo "vulnerabilities_found=true" >> $GITHUB_OUTPUT
            echo "Found vulnerabilities that can be auto-fixed"
          else
            echo "vulnerabilities_found=false" >> $GITHUB_OUTPUT
            echo "No vulnerabilities found or all require manual review"
          fi

      - name: Auto fix vulnerabilities
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        working-directory: ${{ matrix.project }}
        run: |
          echo "🔧 Attempting to auto-fix vulnerabilities..."
          npm audit fix --force || true

      - name: Check if fixes were applied
        if: steps.audit.outputs.vulnerabilities_found == 'true'
        working-directory: ${{ matrix.project }}
        id: check-fixes
        run: |
          if npm audit --audit-level=moderate; then
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
            echo "Some vulnerabilities still remain after auto-fix"
          else
            echo "fixes_applied=true" >> $GITHUB_OUTPUT
            echo "All auto-fixable vulnerabilities were resolved"
          fi

      - name: Create Pull Request
        if: steps.audit.outputs.vulnerabilities_found == 'true' && steps.check-fixes.outputs.fixes_applied == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: '🔒 Auto-fix security vulnerabilities in ${{ matrix.project }}'
          title: '🔒 Security: Auto-fix vulnerabilities in ${{ matrix.project }}'
          body: |
            ## Security Vulnerability Auto-Fix

            This PR automatically fixes security vulnerabilities found in `${{ matrix.project }}` dependencies.

            ### Changes:
            - Updated vulnerable dependencies to secure versions
            - Applied npm audit fixes

            ### Next Steps:
            - [ ] Review the changes
            - [ ] Test the application
            - [ ] Merge if tests pass

            **Note:** This is an automated security fix. Please review carefully before merging.

            ---
            *Auto-generated by GitHub Actions security workflow*
          branch: security/auto-fix-${{ matrix.project }}-${{ github.run_number }}
          base: develop
          delete-branch: true
          labels: |
            security
            dependencies
            auto-fix
